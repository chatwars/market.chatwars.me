;
(function () {
    "use strict";

    angular.element(document).ready(function () {
        angular.module('cwm')
            .config(["$locationProvider", "$stateProvider", "$urlRouterProvider", "$qProvider", "cfpLoadingBarProvider", "$mdThemingProvider", "$mdDialogProvider", function ($locationProvider, $stateProvider, $urlRouterProvider, $qProvider, cfpLoadingBarProvider, $mdThemingProvider, $mdDialogProvider) {
                $locationProvider.html5Mode(true).hashPrefix('!');
                cfpLoadingBarProvider.includeSpinner = true;
                cfpLoadingBarProvider.includeBar = true;
                cfpLoadingBarProvider.parentSelector = '#loading-bar-container';

                $stateProvider
                    .state('cwm', {
                        views: {
                            '@': {
                                templateUrl: 'template/container.html',
                                controller: 'containerCtrl',
                                controllerAs: 'vm'
                            },
                            'header@cwm': {
                                templateUrl: 'header/header.html',
                                controller: 'headerCtrl',
                                controllerAs: 'vm'
                            },
                            'footer@cwm': {
                                templateUrl: 'template/footer.html'
                            }
                        }
                    })
                    .state('cwm.logs', {
                        url: "/logs/:id",
                        views: {
                            'content@cwm': {
                                templateUrl: 'index/index.html',
                                controller: 'indexCtrl',
                                controllerAs: 'vm'
                            }
                        }
                    })
                    .state('cwm.profile', {
                        url: "/profile",
                        views: {
                            'content@cwm': {
                                templateUrl: 'index/index.html',
                                controller: 'indexCtrl',
                                controllerAs: 'vm'
                            }
                        }
                    });

                $urlRouterProvider.otherwise('/logs/');
            }]);

        angular.bootstrap(document, ['cwm']);
    });


    angular
        .module('cwm', [
            'ui.router', 'restangular', 'ngStorage', 'ngSanitize', 'ngMaterial',
            'ngResource', 'ngMessages', 'ngclipboard', 'md.data.table', 'cfp.loadingBar',
            'cwm.templates'
        ])
        .run(["$rootScope", "$state", "$stateParams", function ($rootScope, $state, $stateParams) {
            $rootScope.$state = $state;
            $rootScope.$stateParams = $stateParams;
            $rootScope.flags = {
                "🇨🇾": "1f1e8-1f1fe", // White
                "🇻🇦": "1f1fb-1f1e6", // Yellow
                "🇮🇲": "1f1ee-1f1f2", // Red
                "🇪🇺": "1f1ea-1f1fa", // Blue
                "🇬🇵": "1f1ec-1f1f5", // Black
            }
        }])
})();
(function(angular){
    "use strict";
    profileLinkController.$inject = ["$rootScope"];
    angular.module('cwm')
        .directive('profileLink', profileLinkDirective)
        .controller('profileLinkController', profileLinkController);

    function profileLinkController($rootScope) {
        var ctrl = this;
        var type = '.svg';
        var name = ctrl.profile.name.match(/([🇨🇾|🇻🇦|🇮🇲|🇪🇺|🇬🇵]{4}) (.*)/);

        ctrl.flag = "/img/" + _.get($rootScope.flags, name[1]) + type;
        ctrl.userName = _.trim(name[2]);
    }

    function profileLinkDirective(){
        return {
            restrict: "A",
            scope: {
                profile: "=profileLink"
            },
            template: "<md-icon class='emoji' md-svg-src='{{ vm.flag }}'></md-icon> <a ui-sref='cwm.profile({user: vm.userName})'>{{vm.userName}}</a>",
            controller: 'profileLinkController',
            controllerAs: 'vm',
            bindToController: true,
            link: linkFn
        };

        function linkFn(scope, elem, attrs){

        }
    }

})(angular);
(function(angular){
    "use strict";
    HeaderCtrl.$inject = ["$scope", "$mdSidenav"];
    ContainerCtrl.$inject = ["$scope", "$mdSidenav"];
    angular.module('cwm')
        .controller('headerCtrl', HeaderCtrl)
        .controller('containerCtrl', ContainerCtrl);

    function HeaderCtrl($scope, $mdSidenav){
        var ctrl = this;

        ctrl.toggleSidenav = function () {
            $mdSidenav('left').toggle();
        };

    }

    function ContainerCtrl($scope, $mdSidenav){
        var ctrl = this;

        ctrl.toggleSidenav = function () {
            $mdSidenav('left').toggle();
        };

    }

})(angular);
(function(angular){
    "use strict";
    IndexCtrl.$inject = ["$scope", "$state", "$stateParams", "$mdToast", "StaticService", "$mdSidenav"];
    angular.module('cwm')
        .controller('indexCtrl', IndexCtrl);
    function IndexCtrl($scope, $state, $stateParams, $mdToast, StaticService, $mdSidenav){
        var ctrl = this;

        ctrl.link = location.origin + $state.href('cwm.logs');
        ctrl.data = [];
        ctrl.selected = [];
        ctrl.filterByItems = [];
        ctrl.names = [];
        ctrl.items = [];
        ctrl.selectedItem = null;
        ctrl.searchText = null;

        ctrl.filter = {
            options: {
                debounce: 500
            }
        };

        ctrl.query = {
            filter: '',
            order: '-issuedAt',
        };

        ctrl.pagination = {
            label: {page: 'Страница:', rowsPerPage: 'Записей на странице:', of: 'из'},
            count: 0,
            page: 1,
            limit: 50
        };

        ctrl.options = {
            rowSelection: true,
            multiSelect: true,
            autoSelect: true,
            decapitate: false,
            largeEditDialog: false,
            boundaryLinks: false,
            limitSelect: true,
            pageSelect: true
        };

        ctrl.logic = false;
        ctrl.logicText = {
            true: 'Все предметы',
            false: 'Любой предмет'
        };

        ctrl.expensive = false;

        ctrl.id = $stateParams.id;

        // реквест данных
        ctrl.promise = StaticService.full();

        ctrl.promise.then(function(reply) {
            ctrl.data = (!ctrl.id) ?
                reply.data :
                _.filter(reply.data, function(obj) {
                    return (obj.issuedAt === parseInt(ctrl.id));
                });
            ctrl.pagination.count = reply.data.length;

            _.forEach(reply.data, function(obj, idx) {
                var items = _.merge({}, obj.leftToRight, obj.rightToLeft);
                _.forEach(items, function(cnt, item) {
                    ctrl.items.push(item);
                });
            });
            ctrl.items = _.uniq(ctrl.items);
        });

        ctrl.filterItem = function(item) {
            if (ctrl.filterByItems.length >= 5) {
                $mdToast.show(
                    $mdToast.simple()
                        .textContent('Разрешено не более 5 предметов')
                        .position("top right")
                        .hideDelay(3000)
                        .parent("#toast-container")
                );
                return;
            }
            if (_.indexOf(ctrl.filterByItems, item) == -1) {
                ctrl.filterByItems.push(item)
            }
        };

        ctrl.querySearch = function(query) {
            var results = query ? _.filter(ctrl.items, function(o) {
                return (o.toLowerCase().indexOf(query.toLowerCase()) > -1)
            }) : [];
            return results;
        };

        ctrl.clearFilter = function() {
            ctrl.query.filter = '';
        };

        ctrl.focus = function(ev) {
            if (!angular.element(ev.target).hasClass('md-focused')) {
                angular.element(ev.target).find('input').focus();
            }
        };

        ctrl.toggleSidenav = function () {
            $mdSidenav('left').toggle();
        };

        ctrl.copyLink = function () {
            $mdToast.show(
                $mdToast.simple()
                    .textContent('Ссылка скопирована в буфер обмена')
                    .position("top right")
                    .hideDelay(3000)
                    .parent("#toast-container")
            );
        }
    }

})(angular);
(function (angular) {
    "use strict";
    ByNameFilter.$inject = ["$rootScope", "$q"];
    angular.module('cwm')
        .filter('byName', ByNameFilter);

    function ByNameFilter($rootScope, $q) {
        return function (items, query) {
            if (query === "") {
                return items;
            }
            return _.filter(items, function (item) {
                return  (item.leftUser.name.toLowerCase().indexOf(query.toLowerCase()) > -1) ||
                    (item.rightUser.name.toLowerCase().indexOf(query.toLowerCase()) > -1);
            })
        };

    }

})(angular);
(function (angular) {
    "use strict";
    angular.module('cwm')
        .filter('emoji', EmojiFilter);

    function EmojiFilter() {
        return function (item) {
            return twemoji.parse(item);
        };

    }

})(angular);
(function (angular) {
    "use strict";
    ItemsFilter.$inject = ["$rootScope", "$q"];
    angular.module('cwm')
        .filter('items', ItemsFilter);

    function ItemsFilter($rootScope, $q) {
        return function (items, query, logic) {
            if (_.isArray(query) && query.length > 0) {
                var stock;
                return _.filter(items, function (item) {
                    stock = _.chain([]).concat(_.keys(item.leftToRight), _.keys(item.rightToLeft)).uniq();
                    if (logic) { // И
                        return (_.difference(query, stock.value()).length === 0) ? item : false;
                    } else { // ИЛИ
                        return (_.intersection(query, stock.value()).length > 0) ? item : false;
                    }
                });
            } else {
                return items;
            }
        };

    }

})(angular);
(function(angular){
    "use strict";
    StaticService.$inject = ["$http"];
    angular.module('cwm')
        .service('StaticService', StaticService);

    function StaticService($http){
        var service = {};

        service.local = function(id) {
            return $http.get('json/logs.json');
        };

        service.full = function() {
            return $http.get('/export/lastWeek.json');
        };

        return service;
    }

})(angular);
(function (angular) {
    "use strict";
    angular.module('cwm')
        .filter('udate', UdateFilter);

    function UdateFilter() {
        return function (stamp) {
            var convert = function(val) {
                if (val.toString().length == 1) {
                    return "0" + val;
                } else {
                    return val;
                }
            };

            var a = new Date(stamp * 1000);
            var months = ['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'];
            var year = a.getFullYear();
            var month = months[a.getMonth()];
            var date = a.getDate();
            var hour = convert(a.getHours());
            var min = convert(a.getMinutes());
            var sec = convert(a.getSeconds());
            var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
            return time;
        };



    }

})(angular);
angular.module("cwm.templates", []).run(["$templateCache", function($templateCache) {$templateCache.put('header/header.html','<md-toolbar class="md-hue-2 navbar-fixed"><div class="md-toolbar-tools" show-xs="show-xs" hide-gt-xs="hide-gt-xs" layout-xs="row"><md-button class="md-icon-button" aria-label="Settings" ng-click="vm.toggleSidenav()"><md-icon>menu</md-icon></md-button><div layout-xs="column" layout-align-xs="end center"><h6>Chat Wars Market <br> \u0421\u043F\u0438\u0441\u043E\u043A \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0439 \u043D\u0430 \u0440\u044B\u043D\u043A\u0435</h6></div></div><div class="md-toolbar-tools" hide-xs="hide-xs" show-gt-xs="show-gt-xs"><a class="brand-logo"><span>Chat Wars Market</span></a><md-button class="md-icon-button" aria-label="Settings" ng-click="vm.toggleSidenav()"><md-icon>menu</md-icon></md-button><h2>\u0421\u043F\u0438\u0441\u043E\u043A \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0439 \u043D\u0430 \u0440\u044B\u043D\u043A\u0435</h2></div></md-toolbar>');
$templateCache.put('index/index.html','<md-sidenav class="md-sidenav-left" md-component-id="left" md-whiteframe="4"><md-toolbar class="md-theme-light"><h1 class="md-toolbar-tools">Chat Wars Market</h1></md-toolbar><md-content layout-padding="layout-padding" layout="column"><md-input-container><label class="md-no-float"></label><input type="text" ng-model="vm.query.filter" ng-model-options="vm.filter.options" placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u043C\u0435\u043D\u0438 \u0438\u0433\u0440\u043E\u043A\u0430"/></md-input-container><md-chips flex="flex" ng-model="vm.filterByItems" readonly="false" md-removable="true" md-max-chips="5" md-autocomplete-snap="md-autocomplete-snap" md-require-match="true" ng-click="vm.focus($event)"><md-chip-template><strong>{{$chip}}</strong></md-chip-template><md-autocomplete md-selected-item="vm.selectedItem" md-search-text="vm.searchText" md-items="item in vm.querySearch(vm.searchText)" md-item-text="item" placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u043F\u0440\u0435\u0434\u043C\u0435\u0442\u0443"><span md-highlight-text="vm.searchText">{{item}}</span></md-autocomplete></md-chips><md-switch class="md-primary" ng-model="vm.logic" aria-label="Logic Or/And">{{vm.logicText[vm.logic]}}</md-switch><md-button class="md-primary" ng-click="vm.toggleSidenav()">\u0417\u0430\u043A\u0440\u044B\u0442\u044C</md-button></md-content></md-sidenav><md-toolbar class="md-table-toolbar md-default" id="toast-container" hide-xs="hide-xs" show-gt-xs="show-gt-xs"><div class="md-toolbar-tools"><div layout="row" layout-align="start center" flex="50"><md-icon>search</md-icon><form flex="flex"><label class="md-no-float"></label><input type="text" ng-model="vm.query.filter" ng-model-options="vm.filter.options" placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u043C\u0435\u043D\u0438 \u0438\u0433\u0440\u043E\u043A\u0430"/></form><md-button ng-click="vm.clearFilter()"><md-icon>close</md-icon></md-button></div><div layout="row" layout-align="space-between center" flex="50"><md-chips flex="flex" ng-model="vm.filterByItems" readonly="false" md-removable="true" md-max-chips="5" md-autocomplete-snap="md-autocomplete-snap" md-require-match="true" ng-click="vm.focus($event)"><md-chip-template><strong>{{$chip}}</strong></md-chip-template><md-autocomplete md-selected-item="vm.selectedItem" md-search-text="vm.searchText" md-items="item in vm.querySearch(vm.searchText)" md-item-text="item" placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u043F\u0440\u0435\u0434\u043C\u0435\u0442\u0443"><span md-highlight-text="vm.searchText">{{item}}</span></md-autocomplete></md-chips><md-switch class="md-primary" ng-model="vm.logic" aria-label="Logic Or/And">{{vm.logicText[vm.logic]}}</md-switch><md-checkbox class="md-primary" ng-model="vm.expensive" aria-label="craft">\u0422\u043E\u043B\u044C\u043A\u043E \u043A\u0440\u0430\u0444\u0442</md-checkbox></div></div><md-divider></md-divider></md-toolbar><div layout="row" style="overflow: auto;"><md-content flex="flex" layout-padding=""><md-table-pagination class="no-border" md-limit="vm.pagination.limit" md-limit-options="[20, 50, 100]" md-page="vm.pagination.page" md-total="{{filtered.length}}" md-page-select="vm.options.pageSelect" md-label="{{vm.pagination.label}}"></md-table-pagination><md-table-container><table md-table="md-table" ng-model="vm.selected" md-progress="vm.promise"><thead md-head="md-head" md-order="vm.query.order"><tr md-row="md-row"><th md-column="md-column"></th><th md-column="md-column" md-order-by="leftUser.name"><span>\u042E\u0437\u0435\u0440 1</span></th><th md-column="md-column"><span>\u041F\u0440\u0435\u0434\u043C\u0435\u0442\u044B</span></th><th md-column="md-column"><span>\u041F\u0440\u0435\u0434\u043C\u0435\u0442\u044B</span></th><th md-column="md-column" md-order-by="rightUser.name"><span>\u042E\u0437\u0435\u0440 2</span></th><th md-column="md-column" md-order-by="issuedAt"><span>\u0414\u0430\u0442\u0430</span></th></tr></thead><tbody md-body="md-body"><tr md-row="md-row" ng-repeat="row in filtered = (vm.data|byName:vm.query.filter|items:vm.filterByItems:vm.logic) |orderBy: vm.query.order|limitTo: vm.pagination.limit: (vm.pagination.page - 1) * vm.pagination.limit" md-select="row" md-select-id="$index" md-auto-select="vm.options.autoSelect" ng-class="{\'expensive\':row.expensive}"><td class="row-link" md-cell="md-cell"><md-button class="md-primary md-icon-button" ng-click="vm.copyLink()" ngclipboard="ngclipboard" data-clipboard-text="{{vm.link}}{{row.issuedAt}}"><md-icon>link</md-icon><md-tooltip md-direction="bottom">\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u0437\u0430\u043F\u0438\u0441\u044C</md-tooltip></md-button></td><td md-cell="md-cell" profile-link="row.leftUser"></td><td class="item-list" md-cell="md-cell"><ul><li ng-repeat="(item, cnt) in row.leftToRight" ng-click="vm.filterItem(item)">{{item}}<span class="badge">{{cnt}}</span></li></ul></td><td class="item-list" md-cell="md-cell"><ul><li ng-repeat="(item, cnt) in row.rightToLeft" ng-click="vm.filterItem(item)">{{item}}<span class="badge">{{cnt}}</span></li></ul></td><td md-cell="md-cell" profile-link="row.rightUser"></td><td md-cell="md-cell">{{row.issuedAt|udate}}</td></tr></tbody></table></md-table-container><md-table-pagination md-limit="vm.pagination.limit" md-limit-options="[20, 50, 100]" md-page="vm.pagination.page" md-total="{{filtered.length}}" md-page-select="vm.options.pageSelect" md-label="{{vm.pagination.label}}"></md-table-pagination><div flex=""></div></md-content></div>');
$templateCache.put('template/container.html','<div layout="row" layout-fill="layout-fill"><div flex="flex" layout="column" md-swipe-right="vm.showSidenav()"><ui-view name="header"></ui-view><div ui-view="content" layout="column" style="overflow: auto;" ng-hide="isLoading"></div><ui-view name="footer" ng-hide="isLoading"></ui-view></div></div>');
$templateCache.put('template/footer.html','<md-content layout="row" layout-align="space-around center"><p>ChatWars &copy; 2017&nbsp;<a href="https://t.me/ChatWarsBot" target="blank">@ChatWarsBot</a></p><p>Created by&nbsp;<a href="https://t.me/shaurgon" target="blank">shaurgon</a></p></md-content>');}]);